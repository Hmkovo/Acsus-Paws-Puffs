// name: èŠ‚ç›®å•åŠ©æ‰‹
// description: è§£æå¹¶æ˜¾ç¤ºAIæ¶ˆæ¯ä¸­çš„èŠ‚ç›®å•ï¼Œæ”¯æŒè¿‡å¾€èŠ‚ç›®å­˜å‚¨å’Œæœç´¢
// button:
//   enabled: true
//   visible: true
//   name: ğŸ­ èŠ‚ç›®å•

(function () {
  // ========== æ—¥å¿—ç³»ç»Ÿ ==========
  /**
   * æ—¥å¿—å¼€å…³ - ä¸Šçº¿å‰æ”¹ä¸º false
   * è°ƒè¯•æ—¶ä¿æŒ trueï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
   */
  const ENABLE_LOGGING = true;

  /**
   * ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
   * é€šè¿‡ ENABLE_LOGGING å¼€å…³æ§åˆ¶è¾“å‡º
   */
  const logger = {
    /**
     * è°ƒè¯•æ—¥å¿— - å‡½æ•°å…¥å£ã€åˆ†æ”¯å†³ç­–ã€ä¸­é—´çŠ¶æ€
     */
    debug: (...args) => {
      if (ENABLE_LOGGING) console.log('[èŠ‚ç›®å•][DEBUG]', ...args);
    },
    /**
     * ä¿¡æ¯æ—¥å¿— - é‡è¦æ“ä½œã€çŠ¶æ€å˜æ›´ã€åˆå§‹åŒ–
     */
    info: (...args) => {
      if (ENABLE_LOGGING) console.log('[èŠ‚ç›®å•][INFO]', ...args);
    },
    /**
     * è­¦å‘Šæ—¥å¿— - æ“ä½œå¤±è´¥ã€éªŒè¯å¤±è´¥ã€è¾¹ç•Œæ¡ä»¶
     */
    warn: (...args) => {
      if (ENABLE_LOGGING) console.warn('[èŠ‚ç›®å•][WARN]', ...args);
    },
    /**
     * é”™è¯¯æ—¥å¿— - å¼‚å¸¸æ•è·ã€å…³é”®å¤±è´¥ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
     */
    error: (...args) => {
      console.error('[èŠ‚ç›®å•][ERROR]', ...args);
    }
  };

  // ========== åˆå§‹åŒ–ä¿æŠ¤ ==========
  /**
   * é™æ€æ ‡è®° - é˜²æ­¢é‡å¤åˆå§‹åŒ–
   * @type {boolean}
   */
  let pp_initialized = false;

  // ========== CSSæ ·å¼ ==========
  const STYLES = `
        /* çº¹ç† */
        .texture-subtle {
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }

        /* ===== é¢œè‰²å˜é‡ ===== */
        :root {
            --pp-bg: #202020;
            --pp-curtain: #33334b;
            --pp-curtain-light: #47475f;
            --pp-gold: #f0daab;
            --pp-gold-dim: #c9b886;
            --pp-ivory: #fffeec;
            --pp-pearl: #e6cdc6;
            --pp-mist: #bcacea;
            /* è®¾ç½®å˜é‡ï¼šç•Œé¢ç¼©æ”¾ */
            --pp-scale: 1;
        }

        /* ===== å®¹å™¨ ===== */
        .pp-container {
            position: fixed;
            width: 400px;
            max-width: 90vw;
            z-index: 99998;
            /* åº”ç”¨ç•Œé¢ç¼©æ”¾ */
            transform: scale(var(--pp-scale));
            transform-origin: top left;
        }

        /* ===== å±•å¼€æŒ‰é’® ===== */
        .pp-toggle-btn {
            position: fixed;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2999;
            transition: transform 0.2s;
            background: linear-gradient(135deg, var(--pp-curtain), var(--pp-bg));
            border: 1px solid var(--pp-gold-dim);
            border-radius: 50%;
            /* æ‰‹æœºç«¯è§¦æ‘¸ä¼˜åŒ– */
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .pp-toggle-btn:hover {
            transform: scale(1.15);
        }

        .pp-toggle-btn .icon {
            font-size: 20px;
            color: var(--pp-mist);
        }

        .pp-toggle-btn .badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background: var(--pp-gold);
            color: var(--pp-bg);
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ===== ä¸»é¢æ¿ ===== */
        .pp-panel {
            position: relative;
            background: var(--pp-bg);
            border: 1px solid var(--pp-gold-dim);
            border-radius: 4px;
            overflow: hidden;
            font-family: var(--font-main);
            /* é¢æ¿å±•å¼€åŠ¨ç”» */
            animation: ppReveal 0.35s ease forwards;
        }

        /* ===== å¸·å¹•é¡¶éƒ¨ ===== */
        .pp-curtain-header {
            position: relative;
            height: 46px;
            background: linear-gradient(to bottom, var(--pp-curtain), var(--pp-bg));
            border-bottom: 1px solid;
            border-image: linear-gradient(to right, var(--pp-gold-dim), rgba(240, 218, 171, 0.3), var(--pp-gold-dim)) 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .pp-curtain-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at 75% 20%, rgba(240, 218, 171, 0.15) 0%, transparent 50%), linear-gradient(45deg, transparent 95%, rgba(240, 218, 171, 0.08) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .pp-curtain-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.3) 20%, transparent 40%, transparent 60%, rgba(0, 0, 0, 0.3) 80%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        .pp-header-actions {
            position: absolute;
            right: 12px;
            bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .pp-header-btn {
            background: transparent;
            border: none;
            color: var(--pp-gold-dim);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .pp-header-btn:hover {
            color: var(--pp-gold);
        }

        .pp-curtain-title {
            font-size: 1.05em;
            font-weight: 600;
            letter-spacing: 6px;
            position: relative;
            z-index: 2;
            background: linear-gradient(to right, var(--pp-gold), var(--pp-mist), var(--pp-gold));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            /* æ ‡é¢˜æµå…‰åŠ¨ç”» */
            animation: ppTitleShine 3s ease infinite;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* ===== æ ‡ç­¾åˆ‡æ¢ ===== */
        .pp-tab-bar {
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(240, 218, 171, 0.2);
        }

        .pp-tab-btn {
            flex: 1;
            padding: 10px 6px;
            background: linear-gradient(to bottom, rgba(51, 51, 75, 0.8), rgba(32, 32, 32, 0.9));
            border: 1px solid rgba(240, 218, 171, 0.2);
            border-image: linear-gradient(to bottom, rgba(240, 218, 171, 0.4), rgba(240, 218, 171, 0.1)) 1;
            color: var(--pp-pearl);
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            letter-spacing: 1px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .pp-tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: linear-gradient(to right, var(--pp-gold), var(--pp-mist), var(--pp-gold));
            transition: width 0.25s ease;
        }

        .pp-tab-btn:hover {
            color: var(--pp-gold);
            background: linear-gradient(to bottom, rgba(71, 71, 95, 0.8), rgba(40, 40, 50, 0.9));
            border-color: rgba(240, 218, 171, 0.4);
        }

        .pp-tab-btn.active {
            color: var(--pp-gold);
            background: linear-gradient(to bottom, rgba(71, 71, 95, 0.9), rgba(51, 51, 75, 0.9));
            border-color: var(--pp-gold-dim);
            box-shadow: inset 0 0 15px rgba(240, 218, 171, 0.1);
        }

        .pp-tab-btn.active::after {
            width: 40px;
        }

        .pp-tab-btn .count {
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 2px;
        }

        /* ===== å†…å®¹åŒºåŸŸ ===== */
        .pp-content {
            max-height: 300px;
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(32, 32, 32, 0.98) 0%, rgba(20, 20, 20, 0.99) 100%);
        }

        .pp-content::-webkit-scrollbar {
            width: 4px;
        }

        .pp-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .pp-content::-webkit-scrollbar-thumb {
            background: var(--pp-gold-dim);
            border-radius: 0;
        }

        /* ===== å½“å‰èŠ‚ç›® - ç©ºçŠ¶æ€ ===== */
        .pp-empty {
            padding: 60px 20px;
            text-align: center;
            color: var(--pp-pearl);
            opacity: 0.6;
        }

        .pp-empty .icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
            color: var(--pp-gold-dim);
        }

        .pp-empty .text {
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        /* ===== èŠ‚ç›®å¡ç‰‡ ===== */
        .pp-card {
            margin: 12px;
            background: linear-gradient(145deg, rgba(40, 40, 50, 0.9) 0%, rgba(25, 25, 30, 0.95) 100%);
            border: 1px solid rgba(240, 218, 171, 0.15);
            border-radius: 3px;
            overflow: hidden;
            transition: all 0.25s ease;
            position: relative;
        }

        .pp-card:hover {
            border-color: rgba(240, 218, 171, 0.35);
            transform: translateY(-1px);
        }

        .pp-card.selected {
            border-color: var(--pp-gold-dim);
        }

        .pp-card-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(240, 218, 171, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            cursor: pointer;
            transition: background 0.25s ease;
            position: relative;
        }

        .pp-card-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--pp-gold-dim), transparent);
            z-index: 5;
        }

        .pp-card-header::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 0;
            width: 1px;
            height: 80%;
            background: linear-gradient(to bottom, transparent, var(--pp-gold-dim), transparent);
            z-index: 5;
        }

        .pp-card:hover .pp-card-header {
            background: rgba(240, 218, 171, 0.02);
        }

        .pp-card-topic {
            flex: 1;
            font-size: 0.95em;
            font-weight: 600;
            line-height: 1.4;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            background: linear-gradient(to right, var(--pp-gold), var(--pp-mist));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .pp-card-meta {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .pp-card-tag {
            font-size: 0.7em;
            padding: 3px 8px;
            background: linear-gradient(135deg, rgba(240, 218, 171, 0.15) 0%, rgba(188, 172, 234, 0.1) 100%);
            border: 1px solid rgba(240, 218, 171, 0.4);
            color: var(--pp-gold);
            border-radius: 2px;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .pp-card-expand {
            color: var(--pp-gold-dim);
            font-size: 10px;
            margin-left: 8px;
            padding: 2px 4px;
            opacity: 0.6;
            transition: all 0.25s ease;
        }

        .pp-card.expanded .pp-card-expand {
            opacity: 1;
            color: var(--pp-gold);
        }

        .pp-card-body {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .pp-card.expanded .pp-card-body {
            padding: 12px 15px;
            max-height: 350px;
        }

        .pp-card-desc {
            font-size: 0.85em;
            color: var(--pp-pearl);
            line-height: 1.7;
            margin-bottom: 12px;
            text-align: justify;
            opacity: 0.9;
        }

        .pp-card-actions {
            display: flex;
            gap: 8px;
        }

        .pp-card-btn {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--pp-gold-dim);
            background: transparent;
            border-radius: 2px;
            font-size: 0.8em;
            color: var(--pp-gold);
            cursor: pointer;
            transition: all 0.25s ease;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .pp-card-btn:hover {
            opacity: 0.9;
        }

        .pp-card-btn i {
            font-size: 12px;
        }

        .pp-card-btn-send {
            background: rgba(240, 218, 171, 0.1);
        }

        .pp-card-btn-send:hover {
            background: rgba(240, 218, 171, 0.2);
        }

        .pp-card-btn-js {
            background: rgba(188, 172, 234, 0.1);
            border-color: rgba(188, 172, 234, 0.4);
            color: var(--pp-mist);
        }

        .pp-card-btn-js:hover {
            background: rgba(188, 172, 234, 0.2);
        }

        .pp-card-btn-js.active {
            background: rgba(188, 172, 234, 0.2);
            border-color: var(--pp-mist);
        }

        .pp-card-btn-js input[type="checkbox"] {
            accent-color: var(--pp-mist);
            width: 12px;
            height: 12px;
        }

        /* ===== è¿‡å¾€èŠ‚ç›® ===== */
        .pp-search-bar {
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(240, 218, 171, 0.1);
        }

        .pp-search-input {
            width: 100%;
            padding: 6px 10px;
            padding-left: 32px;
            /* ä½¿ç”¨ !important è¦†ç›– SillyTavern å…¨å±€ input æ ·å¼ */
            background: rgba(185, 172, 187, 0.6) !important;
            border: 1px solid rgba(240, 218, 171, 0.25) !important;
            border-radius: 2px !important;
            color: var(--pp-ivory) !important;
            font-size: 0.8em;
            font-family: var(--font-main);
            transition: all 0.25s ease;
            /* ç¡®ä¿è¾“å…¥æ¡†èƒ½æ­£å¸¸æ¥æ”¶ç‚¹å‡»å’Œè¾“å…¥ */
            pointer-events: auto !important;
            cursor: text !important;
        }

        .pp-search-input::placeholder {
            color: var(--pp-pearl);
            opacity: 0.5;
        }

        .pp-search-input:focus {
            outline: none;
            border-color: var(--pp-gold-dim) !important;
            background: rgba(255, 255, 255, 0.12) !important;
        }

        .pp-search-wrapper {
            position: relative;
        }

        .pp-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--pp-gold-dim);
            opacity: 0.6;
            font-size: 14px;
        }

        .pp-history-item {
            padding: 10px 15px;
            background: linear-gradient(135deg, rgba(40, 40, 50, 0.9) 0%, rgba(25, 25, 30, 0.95) 100%);
            border: 1px solid rgba(240, 218, 171, 0.15);
            border-bottom: 1px solid rgba(240, 218, 171, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .pp-history-item::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 0;
            width: 2px;
            height: 60%;
            background: linear-gradient(to bottom, var(--pp-gold-dim), var(--pp-mist), var(--pp-gold-dim));
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .pp-history-item:hover {
            background: linear-gradient(135deg, rgba(50, 50, 60, 0.9) 0%, rgba(35, 35, 40, 0.95) 100%);
            padding-left: 20px;
            border-color: rgba(240, 218, 171, 0.3);
        }

        .pp-history-item:hover::before {
            opacity: 1;
        }

        .pp-history-item .topic {
            flex: 1;
            font-size: 0.85em;
            background: linear-gradient(to right, var(--pp-pearl), var(--pp-mist));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.5px;
        }

        .pp-history-item .date {
            font-size: 0.7em;
            color: var(--pp-mist);
            margin-left: 10px;
            opacity: 0.7;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .pp-history-item .delete-btn {
            margin-left: 8px;
            background: transparent;
            border: none;
            color: rgba(240, 218, 171, 0.3);
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .pp-history-item:hover .delete-btn {
            opacity: 1;
        }

        .pp-history-item .delete-btn:hover {
            color: #cf6b6b;
        }

        /* ===== æ‰¹é‡åˆ é™¤ ===== */
        .pp-batch-actions {
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid rgba(240, 218, 171, 0.1);
        }

        .pp-batch-btn {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid rgba(188, 172, 234, 0.4);
            background: linear-gradient(135deg, rgba(188, 172, 234, 0.1) 0%, rgba(51, 51, 75, 0.2) 100%);
            border-radius: 2px;
            font-size: 0.8em;
            font-family: var(--font-main);
            color: var(--pp-mist);
            cursor: pointer;
            transition: all 0.25s ease;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: inset 0 0 8px rgba(188, 172, 234, 0.1);
        }

        .pp-batch-btn:hover {
            background: linear-gradient(135deg, rgba(188, 172, 234, 0.2) 0%, rgba(71, 71, 95, 0.3) 100%);
            border-color: rgba(188, 172, 234, 0.6);
            color: var(--pp-gold);
        }

        .pp-batch-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pp-batch-btn i {
            font-size: 14px;
        }

        /* ===== åˆ†é¡µæ§ä»¶ ===== */
        .pp-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(240, 218, 171, 0.1);
        }

        .pp-page-btn {
            background: transparent;
            border: 1px solid rgba(240, 218, 171, 0.3);
            color: var(--pp-gold);
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
        }

        .pp-page-btn:hover:not(:disabled) {
            background: rgba(240, 218, 171, 0.15);
            border-color: var(--pp-gold-dim);
        }

        .pp-page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pp-page-btn.active {
            background: rgba(240, 218, 171, 0.2);
            border-color: var(--pp-gold);
        }

        .pp-page-info {
            font-size: 0.75em;
            color: var(--pp-mist);
            margin: 0 4px;
        }

        /* ===== è®¾ç½®é¡µé¢ï¼ˆæ ‡ç­¾é¡µå½¢å¼ï¼‰ ===== */
        .pp-settings-page {
            padding: 20px;
        }

        .pp-settings-group {
            margin-bottom: 20px;
        }

        .pp-settings-label {
            font-size: 0.75em;
            color: var(--pp-mist);
            margin-bottom: 8px;
            display: block;
            letter-spacing: 1px;
        }

        .pp-settings-input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(240, 218, 171, 0.2);
            border-radius: 2px;
            color: var(--pp-ivory);
            font-size: 0.85em;
            font-family: var(--font-main);
        }

        .pp-settings-input:focus {
            outline: none;
            border-color: var(--pp-gold-dim);
        }

        /* ===== å“åº”å¼ ===== */
        @media (max-width: 480px) {
            .pp-container {
                left: 10px;
                right: 10px;
                width: auto;
            }

            .pp-toggle-btn {
                left: 10px;
            }

            .pp-curtain-title {
                font-size: 0.95em;
                letter-spacing: 3px;
            }
        }

        /* ===== åŠ¨ç”» ===== */
        @keyframes ppReveal {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes ppTitleShine {
            from {
                background-position: 0% center;
            }
            to {
                background-position: 200% center;
            }
        }

        @keyframes ppFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    `;

  // ========== å¸¸é‡ ==========
  const PANEL_ID = 'pp-panel';
  const BTN_ID = 'pp-toggle-btn';
  const STORAGE_KEY_POS = 'pp_position';
  // è®¾ç½®å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ï¼Œä¸å†éœ€è¦æœ¬åœ°å­˜å‚¨key

  // å‘é€æ¨¡æ¿
  const SEND_TEMPLATE = {
    intro: 'ï¼è¯·æ³¨æ„ï¼Œæš‚åœæ‰®æ¼”ï¼Œè¿›è¡Œç»§æ‰¿ä¹‹å‰å…³ç³»ä»¥åŠè®¾å®šçš„æ•…äº‹å±•å¼€ã€‚\nå‘ˆç°æ•…äº‹ï¼Œæœ‰å…³äº ',
    bridge: '\n\nä½ ä¸ä¼šç›´æ¥æœºæ¢°å¤è¿°ä»¥ä¸Šå†…å®¹ï¼Œè€Œæ˜¯æœ‰æœºåœ°ï¼ˆé€‚åº”æ€§åœ°ï¼‰åŠ å…¥æ•…äº‹å½“ä¸­ã€‚å¯¹äºåˆ›ä½œå…ƒç´ æœ¬èº«ï¼Œä½ ä¸ä¼šåŠ å…¥è¿‡äºå¤æ‚æˆ–è€…æš—ç¤ºå¤æ‚ä¸–ç•Œè§‚é˜´è°‹è®ºçš„è§£é‡Šï¼Œè€Œæ˜¯é¿å…è§£é‡Šï¼Œä½œä¸ºèµ·ç‚¹å»¶ä¼¸ã€‚\n\næ‰©å±•è§’åº¦ï¼š\n',
    jsAppend: '\nhtmlå¿…é¡»ç”¨ä¸Šä¸‹```åŒ…è£¹ï¼Œå¹¶ä¸”ä½¿ç”¨åˆç†JavaScriptç‚¹å‡»ä¿¡æ¯å±‚çº§çš„é“¾æ¥æˆ–è€…æ‚¬æµ®ï¼Œè®©é˜…è¯»æœ‰å±‚æ¬¡æ„Ÿï¼Œç¡¬å‚æ•°ä¸¥ç¦min-heightï¼Œè¦æ±‚background:transparentï¼Œå®¹æ˜“é˜…è¯»çš„å¯¹æ¯”æ‰‹æœºç”¨@mediaè€ƒè™‘å°pxå­—ä½“ã€‚'
  };

  // ========== é»˜è®¤è®¾ç½® ==========
  const DEFAULT_SETTINGS = {
    scale: 1
  };

  // ========== çŠ¶æ€ ==========
  let currentProgram = null;      // å½“å‰èŠ‚ç›®æ•°æ®
  let historyPrograms = [];        // è¿‡å¾€èŠ‚ç›®åˆ—è¡¨
  let isPanelOpen = false;
  let currentTab = 'current';      // 'current' | 'history'
  let isSettingsMode = false;      // è®¾ç½®æ¨¡å¼ï¼ˆtrue=è®¾ç½®é¡µï¼Œfalse=ä¸»é¡µé¢ï¼‰
  let searchKeyword = '';
  let settings = { ...DEFAULT_SETTINGS };
  let currentHistoryPage = 1;      // è¿‡å¾€èŠ‚ç›®å½“å‰é¡µç 
  const ITEMS_PER_PAGE = 10;       // æ¯é¡µæ˜¾ç¤ºæ¡æ•°

  // ========== è°ƒè¯•æ—¥å¿— ==========
  const debugLogs = [];
  const MAX_LOGS = 50;

  /**
   * æ·»åŠ è°ƒè¯•æ—¥å¿—
   * @param {string} tag - æ—¥å¿—æ ‡ç­¾
   * @param {string} message - æ—¥å¿—æ¶ˆæ¯
   * @param {*} data - é™„åŠ æ•°æ®ï¼ˆå¯é€‰ï¼‰
   */
  function addDebugLog(tag, message, data = null) {
    const log = {
      time: new Date().toLocaleTimeString('zh-CN', { hour12: false }),
      tag,
      message,
      data: data !== null ? (typeof data === 'string' ? data.substring(0, 200) : JSON.stringify(data).substring(0, 200)) : null
    };
    debugLogs.unshift(log);
    if (debugLogs.length > MAX_LOGS) {
      debugLogs.pop();
    }
  }

  /**
   * è·å–æ ¼å¼åŒ–æ—¥å¿—æ–‡æœ¬
   * @returns {string} æ ¼å¼åŒ–åçš„æ—¥å¿—æ–‡æœ¬
   */
  function getFormattedLogs() {
    return debugLogs.map(log => {
      let text = `[${log.time}] [${log.tag}] ${log.message}`;
      if (log.data) {
        text += `\n  æ•°æ®: ${log.data}`;
      }
      return text;
    }).join('\n\n');
  }

  // ========== æŒ‰é’®æ‹–åŠ¨çŠ¶æ€ ==========
  let dragState = {
    isDragging: false,
    hasMoved: false,
    startX: 0,
    startY: 0,
    startLeft: 0,
    startTop: 0
  };
  const DRAG_THRESHOLD = 5;

  // ========== é¢æ¿æ‹–åŠ¨çŠ¶æ€ ==========
  let panelDragState = {
    isDragging: false,
    startX: 0,
    startY: 0,
    startLeft: 0,
    startTop: 0
  };
  const PANEL_DRAG_THRESHOLD = 3;

  // ========== å·¥å…·å‡½æ•° ==========

  /**
   * æå–å¤šä¸ªJSONå¯¹è±¡ï¼ˆç”¨äºæ ¼å¼2ï¼‰
   * å¤„ç†å½¢å¦‚ï¼š{...} {...} çš„ç»“æ„
   * @param {string} text - åŒ…å«å¤šä¸ªå¯¹è±¡çš„æ–‡æœ¬
   * @returns {Array} èŠ‚ç›®æ•°ç»„
   */
  function extractMultipleObjects(text) {
    const items = [];
    let i = 0;
    let depth = 0;
    let start = -1;
    let braceStack = [];

    for (const char of text) {
      if (char === '{') {
        braceStack.push('{');
        if (braceStack.length === 1) {
          start = i;
        }
      } else if (char === '}') {
        braceStack.pop();
        if (braceStack.length === 0 && start !== -1) {
          const objStr = text.slice(start, i + 1);
          try {
            const obj = JSON.parse(objStr);
            if (obj && obj.topic) {
              items.push(obj);
            }
          } catch (e) {
            // JSONè§£æå¤±è´¥ï¼Œå¿½ç•¥
          }
          start = -1;
        }
      }
      i++;
    }

    return items;
  }

  /**
   * è§£æèŠ‚ç›®å•ï¼ˆé”šç‚¹æ‰«ææ–¹å¼ï¼‰
   * æ”¯æŒæ‰€æœ‰æ ¼å¼ï¼Œä¸ä¾èµ– <èŠ‚ç›®å•> æ ‡ç­¾ï¼ˆæ‰‹æœºç«¯æ­£åˆ™ä¼šåˆ é™¤è¯¥æ ‡ç­¾ï¼‰
   * 
   * æ‰«æç­–ç•¥ï¼š
   * 1. ä» "topic": é”šç‚¹å¼€å§‹
   * 2. åˆ° "javascripts requirement": æˆ– "js requirement": ç»“æŸ
   * 
   * @param {string} text - æ¶ˆæ¯æ–‡æœ¬
   * @returns {Array|null} èŠ‚ç›®æ•°ç»„æˆ–null
   */
  function parseProgram(text) {
    if (!text) {
      addDebugLog('parseProgram', 'æ¶ˆæ¯ä¸ºç©º', null);
      return null;
    }

    addDebugLog('parseProgram', 'å¼€å§‹æ‰«ææ¶ˆæ¯', `é•¿åº¦: ${text.length}`);

    const programs = [];
    let searchStart = 0;

    // ç»“æŸæ ‡è®°æ¨¡å¼ï¼ˆå…¼å®¹ä¸¤ç§å†™æ³•ï¼‰
    const endPatterns = [
      /"javascripts requirement":\s*"[YN]"/,
      /"js requirement":\s*"[YN]"/
    ];

    while (true) {
      // æŸ¥æ‰¾ "topic": é”šç‚¹
      const topicPos = text.indexOf('"topic":', searchStart);
      if (topicPos === -1) {
        // æ²¡æ‰¾åˆ°æ›´å¤š topicï¼Œç»“æŸ
        break;
      }

      addDebugLog('parseProgram', 'æ‰¾åˆ°topicé”šç‚¹', `ä½ç½®: ${topicPos}`);

      // ä» topic ä½ç½®å¼€å§‹ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„ç»“æŸæ ‡è®°
      let contentEnd = -1;
      for (const pattern of endPatterns) {
        const match = pattern.exec(text.slice(topicPos));
        if (match) {
          const endPos = topicPos + match.index + match[0].length;
          if (contentEnd === -1 || endPos < contentEnd) {
            contentEnd = endPos;
          }
        }
      }

      if (contentEnd === -1) {
        // æ²¡æ‰¾åˆ°ç»“æŸæ ‡è®°ï¼Œè·³è¿‡è¿™ä¸ª topicï¼Œç»§ç»­æœç´¢
        addDebugLog('parseProgram', 'æœªæ‰¾åˆ°ç»“æŸæ ‡è®°ï¼Œè·³è¿‡', null);
        searchStart = topicPos + 1;
        continue;
      }

      // æå–èŠ‚ç›®å†…å®¹ï¼Œæ„é€ å®Œæ•´çš„ JSON å¯¹è±¡
      const content = '{' + text.substring(topicPos, contentEnd) + '}';

      try {
        const obj = JSON.parse(content);
        if (obj.topic && obj.genre) {
          programs.push(obj);
          addDebugLog('parseProgram', 'è§£ææˆåŠŸ', obj.topic.substring(0, 30));
        } else {
          addDebugLog('parseProgram', 'ç¼ºå°‘å¿…è¦å­—æ®µï¼Œè·³è¿‡', null);
        }
      } catch (e) {
        // JSON è§£æå¤±è´¥ï¼Œå°è¯•æå–å¿…è¦å­—æ®µ
        const topicMatch = text.substring(topicPos, contentEnd).match(/"topic":\s*"([^"]*)"/);
        const genreMatch = text.substring(topicPos, contentEnd).match(/"genre":\s*"([^"]*)"/);
        const expansionMatch = text.substring(topicPos, contentEnd).match(/"expansion_angles":\s*"([^"]*)"/);
        const styleMatch = text.substring(topicPos, contentEnd).match(/"style":\s*"([^"]*)"/);

        if (topicMatch) {
          programs.push({
            topic: topicMatch[1],
            genre: genreMatch ? genreMatch[1] : '',
            expansion_angles: expansionMatch ? expansionMatch[1] : '',
            style: styleMatch ? styleMatch[1] : ''
          });
          addDebugLog('parseProgram', 'æå–å­—æ®µæˆåŠŸ', topicMatch[1].substring(0, 30));
        }
      }

      // ç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª
      searchStart = contentEnd;
    }

    addDebugLog('parseProgram', 'æ‰«æå®Œæˆ', `${programs.length}ä¸ªèŠ‚ç›®`);
    return programs.length > 0 ? programs : null;
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   * @param {number} timestamp - æ—¶é—´æˆ³
   * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸ
   */
  function formatDate(timestamp) {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  /**
   * ç”Ÿæˆå‘é€å†…å®¹
   * @param {Object} program - èŠ‚ç›®å¯¹è±¡
   * @param {boolean} useJs - æ˜¯å¦ä½¿ç”¨JSæ¨¡æ¿
   * @returns {string} å‘é€å†…å®¹
   */
  function generateSendContent(program, useJs) {
    let content = SEND_TEMPLATE.intro + (program.topic || '') + 'ã€‚\nä½“è£ï¼š' + (program.genre || '') + SEND_TEMPLATE.bridge;
    content += (program.expansion_angles || '') + '\n\né£æ ¼ï¼š' + (program.style || '');

    // å¦‚æœæœ‰ word_countï¼Œè¿½åŠ é¢„è®¡ç¯‡å¹…
    if (program.word_count) {
      content += '\n\né¢„è®¡ç¯‡å¹…ï¼š' + program.word_count;
    }

    // å¦‚æœæœ‰ notesï¼Œè¿½åŠ å‰§ç»„å¤‡æ³¨
    if (program.notes) {
      content += '\nå‰§ç»„å¤‡æ³¨ï¼š' + program.notes;
    }

    if (useJs) {
      content += SEND_TEMPLATE.jsAppend;
    }

    return content;
  }

  /**
   * ä¿å­˜è®¾ç½®
   */
  function saveSettings() {
    localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
    applySettings();
  }

  /**
   * åº”ç”¨è®¾ç½®åˆ°CSSå˜é‡ï¼ˆä½¿ç”¨getTargetDocumentç¡®ä¿è®¾ç½®åˆ°ä¸»çª—å£ï¼‰
   */
  function applySettings() {
    logger.debug('[applySettings] å¼€å§‹åº”ç”¨è®¾ç½®:', JSON.stringify(settings));
    const targetDoc = getTargetDocument();
    const root = targetDoc.documentElement;
    root.style.setProperty('--pp-scale', settings.scale);
    logger.debug('[applySettings] CSSå˜é‡å·²è®¾ç½® --pp-scale:', settings.scale);
  }

  /**
   * è·å–ä¿å­˜çš„ä½ç½®
   */
  function getSavedPosition() {
    const saved = localStorage.getItem(STORAGE_KEY_POS);
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        logger.warn('åŠ è½½ä½ç½®å¤±è´¥:', e);
      }
    }
    return { x: 20, y: 150 };
  }

  /**
   * ä¿å­˜ä½ç½®
   * @param {number} x - Xåæ ‡
   * @param {number} y - Yåæ ‡
   */
  function savePosition(x, y) {
    localStorage.setItem(STORAGE_KEY_POS, JSON.stringify({ x, y }));
  }

  // ========== DOMåˆ›å»º ==========

  /**
   * è·å–ç›®æ ‡æ–‡æ¡£ï¼ˆä¸»çª—å£ï¼‰
   * è„šæœ¬è¿è¡Œåœ¨iframeä¸­ï¼Œéœ€è¦è·å–ä¸»çª—å£çš„documentæ‰èƒ½æ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®
   */
  function getTargetDocument() {
    try {
      if (window.parent && window.parent !== window) {
        if (window.parent.document) {
          return window.parent.document;
        }
      }
    } catch (e) {
      logger.warn('æ— æ³•è®¿é—®çˆ¶çª—å£:', e.message);
    }
    return document;
  }

  /**
   * è·å–ç›®æ ‡çª—å£ï¼ˆä¸»çª—å£ï¼‰
   * è„šæœ¬è¿è¡Œåœ¨iframeä¸­ï¼Œéœ€è¦è·å–ä¸»çª—å£çš„windowæ¥è·å–å°ºå¯¸
   */
  function getTargetWindow() {
    try {
      if (window.parent && window.parent !== window) {
        return window.parent;
      }
    } catch (e) {
      logger.warn('æ— æ³•è®¿é—®çˆ¶çª—å£:', e.message);
    }
    return window;
  }

  /**
   * æ³¨å…¥CSS
   */
  function injectStyles() {
    const targetDoc = getTargetDocument();
    const styleEl = targetDoc.createElement('style');
    styleEl.textContent = STYLES;
    targetDoc.head.appendChild(styleEl);
  }

  /**
   * åˆ›å»ºæ‚¬æµ®æŒ‰é’®
   */
  function createToggleButton() {
    const targetDoc = getTargetDocument();
    const btn = targetDoc.createElement('div');
    btn.id = BTN_ID;
    btn.className = 'pp-toggle-btn';
    btn.innerHTML = '<i class="fa-solid fa-cat icon"></i><span class="badge" style="display:none">0</span>';

    const pos = getSavedPosition();
    btn.style.left = pos.x + 'px';
    btn.style.top = pos.y + 'px';

    // äº‹ä»¶ç»‘å®š - é¼ æ ‡å’Œè§¦æ‘¸åˆ†å¼€å¤„ç†ï¼ˆå­¦ä¹ å¤©å ‚ç³»ç»Ÿï¼‰
    btn.addEventListener('mousedown', onButtonMouseDown);
    btn.addEventListener('touchstart', onButtonTouchStart, { passive: false });

    targetDoc.body.appendChild(btn);
    return btn;
  }

  /**
   * åˆ›å»ºä¸»é¢æ¿
   */
  function createPanel() {
    const targetDoc = getTargetDocument();
    const container = targetDoc.createElement('div');
    container.id = PANEL_ID + '-container';
    container.className = 'pp-container';
    container.style.display = 'none';

    const pos = getSavedPosition();
    container.style.left = pos.x + 'px';
    container.style.top = (pos.y + 50) + 'px';

    container.innerHTML = `
            <div id="${PANEL_ID}" class="pp-panel">
                <div class="pp-curtain-header texture-subtle">
                    <span class="pp-curtain-title">èŠ‚ç›®å•</span>
                    <div class="pp-header-actions">
                        <button class="pp-header-btn" id="pp-settings-btn" title="è®¾ç½®">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                        <button class="pp-header-btn" id="pp-close-panel-btn" title="å…³é—­">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <div class="pp-tab-bar">
                    <button class="pp-tab-btn active" id="pp-tab-current">
                        å½“å‰èŠ‚ç›® <span class="count" id="pp-current-count">(0)</span>
                    </button>
                    <button class="pp-tab-btn" id="pp-tab-history">
                        è¿‡å¾€èŠ‚ç›® <span class="count" id="pp-history-count">(0)</span>
                    </button>
                </div>
                <div id="pp-current-tab" class="pp-content"></div>
                <div id="pp-history-tab" class="pp-content" style="display:none;"></div>
                <div id="pp-settings-tab" class="pp-content" style="display:none;"></div>
            </div>
        `;

    targetDoc.body.appendChild(container);

    // æ”¹ç”¨ addEventListener ç»‘å®šäº‹ä»¶ï¼Œé¿å… onclick å­—ç¬¦ä¸²å½¢å¼çš„æ—¶åºé—®é¢˜
    const settingsBtn = targetDoc.getElementById('pp-settings-btn');
    const closeBtn = targetDoc.getElementById('pp-close-panel-btn');
    const tabCurrent = targetDoc.getElementById('pp-tab-current');
    const tabHistory = targetDoc.getElementById('pp-tab-history');

    // ç‚¹å‡»è®¾ç½®æŒ‰é’®åˆ‡æ¢ä¸»é¡µé¢/è®¾ç½®é¡µ
    settingsBtn.addEventListener('click', function () {
      if (isSettingsMode) {
        showMainPage();
      } else {
        showSettingsPage();
      }
    });
    closeBtn.addEventListener('click', function () {
      isPanelOpen = false;
      isSettingsMode = false;  // å…³é—­é¢æ¿æ—¶é‡ç½®è®¾ç½®æ¨¡å¼
      container.style.display = 'none';
      targetDoc.getElementById(PANEL_ID).classList.remove('open');
    });

    tabCurrent.addEventListener('click', function () {
      switchTab('current');
    });

    tabHistory.addEventListener('click', function () {
      switchTab('history');
    });

    // ç»‘å®šé¢æ¿æ ‡é¢˜æ‹–åŠ¨äº‹ä»¶
    bindPanelDragEvent();

    return container;
  }

  /**
   * æ¸²æŸ“è®¾ç½®é¡µé¢
   */
  function renderSettingsPage() {
    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById('pp-settings-tab');

    container.innerHTML = `
            <div class="pp-settings-page">
                <div class="pp-settings-group">
                    <label class="pp-settings-label">ç•Œé¢å¤§å° (ç¼©æ”¾æ¯”ä¾‹)</label>
                    <input type="number" class="pp-settings-input" id="pp-scale-input"
                           value="${settings.scale}" step="0.1" min="0.6" max="1.5">
                </div>
                <div class="pp-settings-group">
                    <button class="pp-batch-btn" id="pp-save-settings-btn">
                        <i class="fa-solid fa-floppy-disk"></i> ä¿å­˜è®¾ç½®
                    </button>
                </div>
                <hr style="border-color: rgba(240,218,171,0.2); margin: 20px 0;">
                <div class="pp-settings-group">
                    <label class="pp-settings-label">è°ƒè¯•æ—¥å¿— <button class="pp-header-btn" id="pp-clear-logs-btn" title="æ¸…ç©º"><i class="fa-solid fa-trash"></i></button></label>
                    <textarea class="pp-settings-input" id="pp-debug-logs" style="height: 200px; resize: vertical;" readonly>${escapeHtml(getFormattedLogs())}</textarea>
                    <button class="pp-batch-btn" id="pp-copy-logs-btn" style="margin-top: 8px;">
                        <i class="fa-solid fa-copy"></i> å¤åˆ¶æ—¥å¿—
                    </button>
                </div>
            </div>
        `;

    // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
    const saveBtn = targetDoc.getElementById('pp-save-settings-btn');
    if (saveBtn) {
      saveBtn.onclick = saveSettingsFromUI;
    }

    // ç»‘å®šæ¸…ç©ºæ—¥å¿—æŒ‰é’®
    const clearLogsBtn = targetDoc.getElementById('pp-clear-logs-btn');
    if (clearLogsBtn) {
      clearLogsBtn.onclick = function () {
        debugLogs.length = 0;
        renderSettingsPage();
      };
    }

    // ç»‘å®šå¤åˆ¶æ—¥å¿—æŒ‰é’®
    const copyLogsBtn = targetDoc.getElementById('pp-copy-logs-btn');
    if (copyLogsBtn) {
      copyLogsBtn.onclick = async function () {
        const logsText = getFormattedLogs();

        // è·å–ä¸»çª—å£çš„ clipboard APIï¼ˆé…’é¦†åŠ©æ‰‹åœ¨ iframe ä¸­ï¼Œéœ€è¦ç”¨ä¸»çª—å£çš„ APIï¼‰
        const targetWin = getTargetWindow();

        if (targetWin.navigator.clipboard && targetWin.navigator.clipboard.writeText) {
          try {
            await targetWin.navigator.clipboard.writeText(logsText);
            toastr.success('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            return;
          } catch (e) {
            console.warn('[èŠ‚ç›®å•] Clipboard API å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ', e.message);
          }
        }

        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨éšè— textareaï¼ˆæ·»åŠ åˆ°ä¸»çª—å£ï¼‰
        const textarea = targetDoc.createElement('textarea');
        textarea.value = logsText;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        targetDoc.body.appendChild(textarea);
        textarea.select();
        try {
          targetWin.document.execCommand('copy');
          toastr.success('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (e) {
          toastr.warning('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ—¥å¿—æ–‡æœ¬å¹¶å¤åˆ¶');
        }
        targetDoc.body.removeChild(textarea);
      };
    }
  }

  // ========== æ¸²æŸ“ ==========

  /**
   * æ¸²æŸ“å½“å‰èŠ‚ç›®
   */
  function renderCurrentPrograms() {
    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById('pp-current-tab');

    if (!currentProgram || currentProgram.length === 0) {
      container.innerHTML = `
                <div class="pp-empty">
                    <div class="icon"><i class="fa-solid fa-cat"></i></div>
                    <div class="text">ç­‰å¾…èšå…‰ç¯äº®èµ·...</div>
                </div>
            `;
      updateBadge(0);
      return;
    }

    let html = '';
    currentProgram.forEach((item, index) => {
      const escapedTopic = escapeHtml(item.topic || 'æœªå‘½å');
      const escapedGenre = escapeHtml(item.genre || 'è‡ªç”±ä½“è£');
      const escapedDesc = escapeHtml(item.expansion_angles || 'æš‚æ— è¯¦ç»†å¤§çº²ã€‚');
      // å…¼å®¹ä¸¤ç§å­—æ®µåï¼šjs requirement å’Œ javascripts requirement
      const isJs = item['js requirement'] === 'Y' || item['javascripts requirement'] === 'Y';

      html += `
                <div class="pp-card" data-index="${index}">
                    <div class="pp-card-header" data-index="${index}">
                        <div>
                            <div class="pp-card-topic">${escapedTopic}</div>
                            <div class="pp-card-meta">
                                <span class="pp-card-tag">${escapedGenre}</span>
                            </div>
                        </div>
                        <span class="pp-card-expand">Â·Â·Â·</span>
                    </div>
                    <div class="pp-card-body">
                        <div class="pp-card-desc">${escapedDesc}</div>
                        <div class="pp-card-actions">
                            <button class="pp-card-btn pp-card-btn-send" data-index="${index}">
                                <i class="fa-solid fa-paper-plane"></i> å‘é€
                            </button>
                            <button class="pp-card-btn pp-card-btn-js" id="pp-js-btn-${index}" data-index="${index}">
                                <i class="fa-solid fa-code"></i> JS <input type="checkbox" ${isJs ? 'checked' : ''}>
                            </button>
                        </div>
                    </div>
                </div>
            `;
    });

    container.innerHTML = html;
    updateBadge(currentProgram.length);

    // ç»‘å®šå¡ç‰‡äº‹ä»¶ï¼ˆä½¿ç”¨é—­åŒ…ï¼Œä¸ä¾èµ–å…¨å±€å‡½æ•°ï¼‰
    container.querySelectorAll('.pp-card-header').forEach(header => {
      header.addEventListener('click', function () {
        const index = parseInt(this.getAttribute('data-index'), 10);
        const card = this.closest('.pp-card');
        card.classList.toggle('expanded');
      });
    });

    container.querySelectorAll('.pp-card-btn-send').forEach(btn => {
      btn.addEventListener('click', async function () {
        const index = parseInt(this.getAttribute('data-index'), 10);
        await sendProgram(index);
      });
    });

    container.querySelectorAll('.pp-card-btn-js').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-index'), 10);
        this.classList.toggle('active');
        const checkbox = this.querySelector('input[type="checkbox"]');
        checkbox.checked = this.classList.contains('active');
      });
    });
  }

  /**
   * æ¸²æŸ“æœç´¢æ ï¼ˆåªæ¸²æŸ“ä¸€æ¬¡ï¼Œä¸éšåˆ—è¡¨åˆ·æ–°ï¼‰
   */
  function renderSearchBar() {
    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById('pp-history-tab');

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æœç´¢æ ï¼Œé¿å…é‡å¤æ¸²æŸ“å¯¼è‡´è¾“å…¥æ¡†ä¸¢å¤±ç„¦ç‚¹
    if (container.querySelector('.pp-search-bar')) {
      return;
    }

    // æœç´¢æ HTML
    const searchBarHtml = `
            <div class="pp-search-bar">
                <div class="pp-search-wrapper">
                    <i class="fa-solid fa-magnifying-glass pp-search-icon"></i>
                    <input type="text" class="pp-search-input" id="pp-search-input"
                           placeholder="æœç´¢è¿‡å¾€èŠ‚ç›®..." value="${escapeHtml(searchKeyword)}">
                </div>
            </div>
            <div class="pp-history-list"></div>
            <div class="pp-pagination" id="pp-pagination" style="display:none;"></div>
            <div class="pp-batch-actions"></div>
        `;

    container.innerHTML = searchBarHtml;

    // ç»‘å®šæœç´¢äº‹ä»¶
    const searchInput = targetDoc.getElementById('pp-search-input');
    if (searchInput) {
      searchInput.oninput = function () {
        searchKeyword = this.value;
        renderHistoryList();  // åªåˆ·æ–°åˆ—è¡¨ï¼Œä¸åˆ·æ–°æœç´¢æ 
      };
    }
  }

  /**
   * è®¡ç®—è¿‡æ»¤åçš„å†å²æ¡ç›®ï¼ˆç”¨äºåˆ†é¡µï¼‰
   * @returns {Object} åŒ…å«å®Œæ•´æ•°æ®
   */
  function getFilteredHistoryItems() {
    let items = historyPrograms;

    // æœç´¢è¿‡æ»¤
    if (searchKeyword) {
      const keyword = searchKeyword.toLowerCase();
      items = items.filter(item =>
        (item.topic || '').toLowerCase().includes(keyword) ||
        (item.genre || '').toLowerCase().includes(keyword)
      );
    }

    const totalPages = Math.max(1, Math.ceil(items.length / ITEMS_PER_PAGE));

    // ç¡®ä¿é¡µç åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (currentHistoryPage > totalPages) {
      currentHistoryPage = totalPages;
    }

    // è®¡ç®—å½“å‰é¡µçš„èµ·å§‹ç´¢å¼•å’Œåˆ‡ç‰‡
    const startIndex = (currentHistoryPage - 1) * ITEMS_PER_PAGE;
    const pageItems = items.slice(startIndex, startIndex + ITEMS_PER_PAGE);

    return { filteredItems: items, pageItems, startIndex, totalPages, totalCount: items.length };
  }

  /**
   * æ¸²æŸ“å†å²åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
   */
  function renderHistoryList() {
    const targetDoc = getTargetDocument();
    const listContainer = targetDoc.querySelector('#pp-history-tab .pp-history-list');
    const batchContainer = targetDoc.querySelector('#pp-history-tab .pp-batch-actions');
    const paginationContainer = targetDoc.getElementById('pp-pagination');
    const countEl = targetDoc.getElementById('pp-history-count');

    if (!listContainer) {
      // åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨ï¼Œè¯´æ˜è¿˜æ²¡åˆå§‹åŒ–ï¼Œå…ˆæ¸²æŸ“æœç´¢æ 
      renderSearchBar();
      return;
    }

    const { pageItems, startIndex, totalPages, totalCount } = getFilteredHistoryItems();

    // æ›´æ–°æ•°é‡æ˜¾ç¤º
    if (countEl) {
      countEl.textContent = `(${totalCount})`;
    }

    // ç©ºçŠ¶æ€æˆ–åˆ—è¡¨
    let listHtml = '';
    if (totalCount === 0) {
      listHtml = `
                <div class="pp-empty">
                    <div class="icon"><i class="fa-solid fa-inbox"></i></div>
                    <div class="text">${searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç›®' : 'æš‚æ— è¿‡å¾€èŠ‚ç›®'}</div>
                </div>
            `;
    } else {
      pageItems.forEach((item, idx) => {
        const escapedTopic = escapeHtml(item.topic || 'æœªå‘½å');
        const date = formatDate(item.timestamp || Date.now());
        // ä½¿ç”¨çœŸå®ç´¢å¼•ï¼ˆå®Œæ•´è¿‡æ»¤åˆ—è¡¨ä¸­çš„ä½ç½®ï¼‰
        const realIndex = startIndex + idx;

        listHtml += `
                <div class="pp-history-item" data-idx="${realIndex}">
                    <span class="topic">${escapedTopic}</span>
                    <span class="date">${date}</span>
                    <button class="delete-btn" data-idx="${realIndex}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `;
      });
    }

    listContainer.innerHTML = listHtml;

    // æ¸²æŸ“åˆ†é¡µæ§ä»¶ï¼ˆè¶…è¿‡10æ¡æ‰æ˜¾ç¤ºï¼‰
    if (totalPages > 1) {
      paginationContainer.style.display = 'flex';
      paginationContainer.innerHTML = `
                <button class="pp-page-btn" id="pp-page-prev" ${currentHistoryPage <= 1 ? 'disabled' : ''}>
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <span class="pp-page-info">${currentHistoryPage} / ${totalPages}</span>
                <button class="pp-page-btn" id="pp-page-next" ${currentHistoryPage >= totalPages ? 'disabled' : ''}>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            `;

      // ç»‘å®šç¿»é¡µäº‹ä»¶
      const prevBtn = targetDoc.getElementById('pp-page-prev');
      const nextBtn = targetDoc.getElementById('pp-page-next');

      if (prevBtn) {
        prevBtn.onclick = function () {
          if (currentHistoryPage > 1) {
            currentHistoryPage--;
            renderHistoryList(); // åªåˆ·æ–°åˆ—è¡¨ï¼Œé¡µç ä¿æŒ
          }
        };
      }

      if (nextBtn) {
        nextBtn.onclick = function () {
          if (currentHistoryPage < totalPages) {
            currentHistoryPage++;
            renderHistoryList(); // åªåˆ·æ–°åˆ—è¡¨ï¼Œé¡µç ä¿æŒ
          }
        };
      }
    } else {
      paginationContainer.style.display = 'none';
    }

    // æ‰¹é‡æ“ä½œï¼ˆåªæœ‰éç©ºæ—¶æ˜¾ç¤ºï¼‰
    if (totalCount > 0) {
      batchContainer.innerHTML = `
                <button class="pp-batch-btn" id="pp-clear-all-btn">
                    <i class="fa-solid fa-trash-can"></i> æ¸…ç©ºè¿‡å¾€èŠ‚ç›®
                </button>
            `;

      // ç»‘å®šæ¸…ç©ºæŒ‰é’®
      const clearBtn = targetDoc.getElementById('pp-clear-all-btn');
      if (clearBtn) {
        clearBtn.onclick = async function () {
          if (await clearAllHistory()) {
            renderHistoryList();
          }
        };
      }
    } else {
      batchContainer.innerHTML = '';
    }

    // ç»‘å®šå†å²é¡¹ç›®ç‚¹å‡»äº‹ä»¶
    listContainer.querySelectorAll('.pp-history-item').forEach(item => {
      item.addEventListener('click', function () {
        const idx = parseInt(this.getAttribute('data-idx'), 10);
        loadFromHistory(idx);
      });
    });

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    listContainer.querySelectorAll('.pp-history-item .delete-btn').forEach(btn => {
      btn.addEventListener('click', async function (e) {
        e.stopPropagation();
        const idx = parseInt(this.getAttribute('data-idx'), 10);
        await deleteHistory(idx);
        renderHistoryList(); // åªåˆ·æ–°åˆ—è¡¨
      });
    });
  }

  /**
   * æ¸²æŸ“è¿‡å¾€èŠ‚ç›®ï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œå†…éƒ¨æ‹†åˆ†ä¸º renderSearchBar + renderHistoryListï¼‰
   */
  function renderHistoryPrograms() {
    renderSearchBar();
    renderHistoryList();
  }

  /**
   * æ›´æ–°å¾½ç« 
   */
  function updateBadge(count) {
    const targetDoc = getTargetDocument();
    const btn = targetDoc.getElementById(BTN_ID);
    const badge = btn.querySelector('.badge');
    if (badge) {
      badge.textContent = count;
      badge.style.display = count > 0 ? 'block' : 'none';
    }
    targetDoc.getElementById('pp-current-count').textContent = `(${count})`;
  }

  /**
   * æ›´æ–°è¿‡å¾€èŠ‚ç›®æ•°é‡
   */
  function updateHistoryCount(count) {
    const targetDoc = getTargetDocument();
    targetDoc.getElementById('pp-history-count').textContent = `(${count})`;
  }

  /**
   * HTMLè½¬ä¹‰
   */
  function escapeHtml(text) {
    const targetDoc = getTargetDocument();
    const div = targetDoc.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // ========== äº‹ä»¶å¤„ç† ==========

  /**
   * æŒ‰é’®é¼ æ ‡æŒ‰ä¸‹ï¼ˆå­¦ä¹ å¤©å ‚ç³»ç»Ÿ - åªå¤„ç†é¼ æ ‡ï¼‰
   */
  function onButtonMouseDown(e) {
    const targetDoc = getTargetDocument();
    const btn = e.currentTarget;

    dragState.isDragging = true;
    dragState.hasMoved = false;
    dragState.startX = e.clientX;
    dragState.startY = e.clientY;
    dragState.startLeft = btn.offsetLeft;
    dragState.startTop = btn.offsetTop;

    // åˆ›å»ºäº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆé—­åŒ…å¼•ç”¨ï¼‰
    const onMouseMove = (e) => onButtonMouseMove(e);
    const onMouseUp = (e) => {
      onButtonMouseUp(e);
      targetDoc.removeEventListener('mousemove', onMouseMove);
      targetDoc.removeEventListener('mouseup', onMouseUp);
    };

    // ç»‘å®šé¼ æ ‡äº‹ä»¶
    targetDoc.addEventListener('mousemove', onMouseMove);
    targetDoc.addEventListener('mouseup', onMouseUp);
  }

  /**
   * æŒ‰é’®é¼ æ ‡ç§»åŠ¨ï¼ˆå­¦ä¹ å¤©å ‚ç³»ç»Ÿï¼‰
   */
  function onButtonMouseMove(e) {
    if (!dragState.isDragging) return;

    const deltaX = e.clientX - dragState.startX;
    const deltaY = e.clientY - dragState.startY;

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ‹–åŠ¨é˜ˆå€¼
    if (Math.abs(deltaX) > DRAG_THRESHOLD || Math.abs(deltaY) > DRAG_THRESHOLD) {
      dragState.hasMoved = true;
    }

    if (dragState.hasMoved) {
      let newX = dragState.startLeft + deltaX;
      let newY = dragState.startTop + deltaY;

      // é™åˆ¶åœ¨è§†å£å†…
      const targetWin = getTargetWindow();
      newX = Math.max(0, Math.min(newX, targetWin.innerWidth - 50));
      newY = Math.max(0, Math.min(newY, targetWin.innerHeight - 50));

      const targetDoc = getTargetDocument();
      const btn = targetDoc.getElementById(BTN_ID);
      btn.style.left = newX + 'px';
      btn.style.top = newY + 'px';

      // åŒæ­¥é¢æ¿ä½ç½®
      const container = targetDoc.getElementById(PANEL_ID + '-container');
      if (container) {
        container.style.left = newX + 'px';
        container.style.top = (newY + 50) + 'px';
      }
    }
  }

  /**
   * æŒ‰é’®é¼ æ ‡é‡Šæ”¾ï¼ˆå­¦ä¹ å¤©å ‚ç³»ç»Ÿï¼‰
   */
  function onButtonMouseUp(e) {
    dragState.isDragging = false;

    if (dragState.hasMoved) {
      const targetDoc = getTargetDocument();
      const btn = targetDoc.getElementById(BTN_ID);
      savePosition(btn.offsetLeft, btn.offsetTop);
    } else {
      // ç‚¹å‡» -> åˆ‡æ¢é¢æ¿
      togglePanel();
    }
  }

  /**
   * æŒ‰é’®è§¦æ‘¸å¼€å§‹ï¼ˆå­¦ä¹ å¤©å ‚ç³»ç»Ÿ - ç‹¬ç«‹çš„è§¦æ‘¸å¤„ç†ï¼‰
   */
  function onButtonTouchStart(e) {
    e.preventDefault(); // â­ å…³é”®ï¼ç«‹å³é˜»æ­¢é»˜è®¤è¡Œä¸º
    const touch = e.touches[0];

    const targetDoc = getTargetDocument();
    const btn = e.currentTarget;

    dragState.isDragging = true;
    dragState.hasMoved = false;
    dragState.startX = touch.clientX;
    dragState.startY = touch.clientY;
    dragState.startLeft = btn.offsetLeft;
    dragState.startTop = btn.offsetTop;

    // è§¦æ‘¸ç§»åŠ¨å¤„ç†ï¼ˆç‹¬ç«‹çš„é—­åŒ…ï¼‰
    const onTouchMove = (e) => {
      const touch = e.touches[0];
      const deltaX = touch.clientX - dragState.startX;
      const deltaY = touch.clientY - dragState.startY;

      if (Math.abs(deltaX) > DRAG_THRESHOLD || Math.abs(deltaY) > DRAG_THRESHOLD) {
        dragState.hasMoved = true;
      }

      if (dragState.hasMoved) {
        // é˜»æ­¢æ»šåŠ¨
        e.preventDefault();
        e.stopPropagation();

        let newX = dragState.startLeft + deltaX;
        let newY = dragState.startTop + deltaY;

        // é™åˆ¶åœ¨è§†å£å†…
        const targetWin = getTargetWindow();
        newX = Math.max(0, Math.min(newX, targetWin.innerWidth - 50));
        newY = Math.max(0, Math.min(newY, targetWin.innerHeight - 50));

        btn.style.left = newX + 'px';
        btn.style.top = newY + 'px';

        // åŒæ­¥é¢æ¿ä½ç½®
        const container = targetDoc.getElementById(PANEL_ID + '-container');
        if (container) {
          container.style.left = newX + 'px';
          container.style.top = (newY + 50) + 'px';
        }
      }
    };

    // è§¦æ‘¸ç»“æŸå¤„ç†
    const onTouchEnd = () => {
      dragState.isDragging = false;
      if (dragState.hasMoved) {
        savePosition(btn.offsetLeft, btn.offsetTop);
      } else {
        togglePanel();
      }
      targetDoc.removeEventListener('touchmove', onTouchMove);
      targetDoc.removeEventListener('touchend', onTouchEnd);
    };

    // ç»‘å®šè§¦æ‘¸äº‹ä»¶
    targetDoc.addEventListener('touchmove', onTouchMove, { passive: false });
    targetDoc.addEventListener('touchend', onTouchEnd);
  }

  /**
   * åˆ‡æ¢é¢æ¿æ˜¾ç¤º
   */
  function togglePanel() {
    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById(PANEL_ID + '-container');
    const panel = targetDoc.getElementById(PANEL_ID);

    if (isPanelOpen) {
      // å…³é—­åŠ¨ç”»
      panel.style.opacity = '0';
      panel.style.transform = 'translateY(-15px)';
      panel.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
      isPanelOpen = false;

      // åŠ¨ç”»ç»“æŸåéšè—
      setTimeout(() => {
        container.style.display = 'none';
        panel.classList.remove('open');
        panel.style.opacity = '';
        panel.style.transform = '';
        panel.style.transition = '';
      }, 200);
    } else {
      // åˆ·æ–°æ•°æ®
      refreshData();
      container.style.display = 'block';
      panel.classList.add('open');
      // è§¦å‘CSSåŠ¨ç”»
      panel.style.animation = 'none';
      panel.offsetHeight; // å¼ºåˆ¶é‡ç»˜
      panel.style.animation = 'ppReveal 0.35s ease forwards';
      isPanelOpen = true;
    }
  }

  // ========== é¢æ¿æ‹–åŠ¨ç›¸å…³å‡½æ•° ==========

  /**
   * é¢æ¿é¼ æ ‡æŒ‰ä¸‹
   */
  function onPanelMouseDown(e) {
    // å¿½ç•¥å…³é—­æŒ‰é’®çš„ç‚¹å‡»
    if (e.target.closest('.pp-header-btn')) return;

    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById(PANEL_ID + '-container');
    if (!container) return;

    e.preventDefault();
    e.stopPropagation();

    panelDragState.isDragging = true;
    panelDragState.startX = e.clientX || e.touches?.[0]?.clientX;
    panelDragState.startY = e.clientY || e.touches?.[0]?.clientY;
    panelDragState.startLeft = container.offsetLeft;
    panelDragState.startTop = container.offsetTop;

    // ç»‘å®šå…¨å±€ç§»åŠ¨å’Œé‡Šæ”¾äº‹ä»¶
    const onMouseMove = (e) => onPanelMouseMove(e);
    const onMouseUp = (e) => {
      onPanelMouseUp(e);
      targetDoc.removeEventListener('mousemove', onMouseMove);
      targetDoc.removeEventListener('mouseup', onMouseUp);
      targetDoc.removeEventListener('touchmove', onMouseMove);
      targetDoc.removeEventListener('touchend', onMouseUp);
    };

    targetDoc.addEventListener('mousemove', onMouseMove, { passive: false });
    targetDoc.addEventListener('mouseup', onMouseUp);
    targetDoc.addEventListener('touchmove', onMouseMove, { passive: false });
    targetDoc.addEventListener('touchend', onMouseUp);
  }

  /**
   * é¢æ¿é¼ æ ‡ç§»åŠ¨
   */
  function onPanelMouseMove(e) {
    if (!panelDragState.isDragging) return;

    e.preventDefault();
    e.stopPropagation();

    const clientX = e.clientX || e.touches?.[0]?.clientX;
    const clientY = e.clientY || e.touches?.[0]?.clientY;

    const deltaX = clientX - panelDragState.startX;
    const deltaY = clientY - panelDragState.startY;

    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById(PANEL_ID + '-container');
    if (!container) return;

    // è®¡ç®—æ–°ä½ç½®
    let newLeft = panelDragState.startLeft + deltaX;
    let newTop = panelDragState.startTop + deltaY;

    // é™åˆ¶åœ¨è§†å£å†…
    const targetWin = getTargetWindow();
    const maxX = targetWin.innerWidth - 400; // é¢æ¿å®½åº¦
    const maxY = targetWin.innerHeight - 500; // é¢æ¿å¤§è‡´é«˜åº¦

    newLeft = Math.max(0, Math.min(newLeft, maxX));
    newTop = Math.max(0, Math.min(newTop, maxY));

    container.style.left = newLeft + 'px';
    container.style.top = newTop + 'px';
  }

  /**
   * é¢æ¿é¼ æ ‡é‡Šæ”¾
   */
  function onPanelMouseUp(e) {
    if (!panelDragState.isDragging) return;

    panelDragState.isDragging = false;

    // ä¿å­˜ä½ç½®
    const targetDoc = getTargetDocument();
    const container = targetDoc.getElementById(PANEL_ID + '-container');
    if (container) {
      savePosition(container.offsetLeft, container.offsetTop);
    }
  }

  /**
   * ä¸ºé¢æ¿æ ‡é¢˜ç»‘å®šæ‹–åŠ¨äº‹ä»¶
   */
  function bindPanelDragEvent() {
    const targetDoc = getTargetDocument();
    const header = targetDoc.querySelector('.pp-curtain-header');
    if (header) {
      header.addEventListener('mousedown', onPanelMouseDown);
      header.addEventListener('touchstart', onPanelMouseDown, { passive: false });
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  async function refreshData() {
    addDebugLog('refreshData', 'å¼€å§‹åˆ·æ–°æ•°æ®', null);

    // è§£æå½“å‰æ¶ˆæ¯
    const messages = getChatMessages('-1');
    addDebugLog('refreshData', 'è·å–æ¶ˆæ¯', `æ•°é‡: ${messages.length}`);

    if (messages.length > 0) {
      const msg = messages[0];
      const rawMessage = msg.message || '';
      const messagePreview = rawMessage.substring(0, 200).replace(/\n/g, '\\n');
      addDebugLog('refreshData', 'æ¶ˆæ¯å†…å®¹(å‰200å­—ç¬¦)', messagePreview);

      const program = parseProgram(rawMessage);

      addDebugLog('refreshData', 'è§£æç»“æœ', program ? `${program.length}ä¸ªèŠ‚ç›®` : 'null');

      if (program && program.length > 0) {
        currentProgram = program;
        addDebugLog('refreshData', 'è®¾ç½®currentProgram', program[0].topic);

        // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ï¼ˆä¸æ‰«æèŠå¤©è®°å½•ï¼‰
        const history = getVariables({ type: 'chat' });
        if (!history.program_history) {
          history.program_history = [];
        }

        // æ£€æŸ¥å¹¶ä¿å­˜æ¯ä¸ªèŠ‚ç›®ï¼ˆæ¯ä¸ªèŠ‚ç›®å•ç‹¬æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼‰
        let savedCount = 0;
        program.forEach(p => {
          const exists = history.program_history.some(
            existing => existing.topic === p.topic
          );
          if (!exists) {
            history.program_history.push({
              ...p,
              timestamp: Date.now()
            });
            savedCount++;
          }
        });

        if (savedCount > 0) {
          replaceVariables(history, { type: 'chat' });
          addDebugLog('refreshData', 'ä¿å­˜åˆ°å†å²', `${savedCount}ä¸ªæ–°èŠ‚ç›®`);
        }
      } else {
        currentProgram = null;
        addDebugLog('refreshData', 'æœªè§£æåˆ°èŠ‚ç›®', null);
      }
    } else {
      currentProgram = null;
      addDebugLog('refreshData', 'æ— æ¶ˆæ¯', null);
    }

    // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½è¿‡å¾€èŠ‚ç›®
    const history = getVariables({ type: 'chat' });
    historyPrograms = (history.program_history || []).sort(
      (a, b) => (b.timestamp || 0) - (a.timestamp || 0)
    );

    // æ ¹æ®å½“å‰Tabæ¸²æŸ“
    if (currentTab === 'current') {
      renderCurrentPrograms();
    } else {
      renderHistoryPrograms();
    }
  }

  /**
   * åˆ‡æ¢Tab
   */
  function switchTab(tab) {
    currentTab = tab;
    const targetDoc = getTargetDocument();

    targetDoc.querySelectorAll('.pp-tab-btn').forEach(btn => btn.classList.remove('active'));

    // æ ¹æ®tabåç§°æ¿€æ´»å¯¹åº”æŒ‰é’®
    const tabBtn = targetDoc.getElementById('pp-tab-' + tab);
    if (tabBtn) {
      tabBtn.classList.add('active');
    }

    targetDoc.getElementById('pp-current-tab').style.display = tab === 'current' ? 'block' : 'none';
    targetDoc.getElementById('pp-history-tab').style.display = tab === 'history' ? 'block' : 'none';
    targetDoc.getElementById('pp-settings-tab').style.display = 'none';

    if (tab === 'history') {
      renderHistoryPrograms();
    }
  }

  /**
   * è¿›å…¥è®¾ç½®é¡µé¢
   * éšè—æ ‡ç­¾æ ï¼Œæ˜¾ç¤ºè®¾ç½®å†…å®¹
   */
  function showSettingsPage() {
    isSettingsMode = true;
    const targetDoc = getTargetDocument();
    const panel = targetDoc.getElementById(PANEL_ID);
    const tabBar = targetDoc.querySelector('.pp-tab-bar');
    const title = targetDoc.querySelector('.pp-curtain-title');
    const settingsBtn = targetDoc.getElementById('pp-settings-btn');

    // éšè—æ ‡ç­¾æ 
    tabBar.style.display = 'none';

    // éšè—å½“å‰èŠ‚ç›®å’Œè¿‡å¾€èŠ‚ç›®å†…å®¹
    targetDoc.getElementById('pp-current-tab').style.display = 'none';
    targetDoc.getElementById('pp-history-tab').style.display = 'none';

    // æ˜¾ç¤ºè®¾ç½®å†…å®¹
    targetDoc.getElementById('pp-settings-tab').style.display = 'block';
    renderSettingsPage();

    // ä¿®æ”¹æ ‡é¢˜
    title.textContent = 'è®¾ç½®';

    // ä¿®æ”¹è®¾ç½®æŒ‰é’®ä¸ºè¿”å›å›¾æ ‡
    settingsBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
    settingsBtn.title = 'è¿”å›';
  }

  /**
   * è¿”å›ä¸»é¡µé¢
   * æ˜¾ç¤ºæ ‡ç­¾æ ï¼Œå›åˆ°å½“å‰èŠ‚ç›®tab
   */
  function showMainPage() {
    isSettingsMode = false;
    const targetDoc = getTargetDocument();
    const panel = targetDoc.getElementById(PANEL_ID);
    const tabBar = targetDoc.querySelector('.pp-tab-bar');
    const title = targetDoc.querySelector('.pp-curtain-title');
    const settingsBtn = targetDoc.getElementById('pp-settings-btn');

    // æ˜¾ç¤ºæ ‡ç­¾æ 
    tabBar.style.display = 'flex';

    // æ˜¾ç¤ºå½“å‰èŠ‚ç›®tabï¼ˆé»˜è®¤ï¼‰
    targetDoc.getElementById('pp-current-tab').style.display = 'block';
    targetDoc.getElementById('pp-history-tab').style.display = 'none';
    targetDoc.getElementById('pp-settings-tab').style.display = 'none';

    // åˆ‡æ¢åˆ°å½“å‰èŠ‚ç›®tab
    switchTab('current');

    // æ¢å¤æ ‡é¢˜
    title.textContent = 'èŠ‚ç›®å•';

    // æ¢å¤è®¾ç½®æŒ‰é’®å›¾æ ‡
    settingsBtn.innerHTML = '<i class="fa-solid fa-gear"></i>';
    settingsBtn.title = 'è®¾ç½®';
  }

  /**
   * å±•å¼€/æ”¶èµ·å¡ç‰‡
   */
  function expandCard(index) {
    const targetDoc = getTargetDocument();
    const cards = targetDoc.querySelectorAll('.pp-card');
    cards.forEach((card, i) => {
      if (i === index) {
        card.classList.toggle('expanded');
      }
    });
  }

  /**
   * åˆ‡æ¢JSå¼€å…³
   */
  function toggleJs(index) {
    const targetDoc = getTargetDocument();
    const btn = targetDoc.getElementById('pp-js-btn-' + index);
    const checkbox = btn.querySelector('input[type="checkbox"]');
    btn.classList.toggle('active');
    checkbox.checked = btn.classList.contains('active');
  }

  /**
   * å‘é€èŠ‚ç›®
   */
  async function sendProgram(index) {
    if (!currentProgram || !currentProgram[index]) return;

    const program = currentProgram[index];
    const targetDoc = getTargetDocument();
    const btn = targetDoc.getElementById('pp-js-btn-' + index);
    const useJs = btn && btn.classList.contains('active');

    const content = generateSendContent(program, useJs);

    // å‘é€åˆ°èŠå¤©æ¡†
    triggerSlash('/send ' + content);

    toastr.success('å·²å‘é€: ' + (program.topic || 'æœªå‘½å'));
  }

  /**
   * ä»è¿‡å¾€åŠ è½½
   */
  function loadFromHistory(index) {
    const { filteredItems } = getFilteredHistoryItems();

    if (!filteredItems[index]) return;

    const item = filteredItems[index];
    currentProgram = [item];

    switchTab('current');
    renderCurrentPrograms();
    toastr.info('å·²åŠ è½½: ' + (item.topic || 'æœªå‘½å'));
  }

  /**
   * åˆ é™¤å•ä¸ªå†å²
   */
  function deleteHistory(index) {
    let items = historyPrograms;
    if (searchKeyword) {
      const keyword = searchKeyword.toLowerCase();
      items = items.filter(item =>
        (item.topic || '').toLowerCase().includes(keyword) ||
        (item.genre || '').toLowerCase().includes(keyword)
      );
    }

    if (!items[index]) return;
    const item = items[index];

    // ä»æŒä¹…åŒ–å­˜å‚¨ä¸­åˆ é™¤
    const history = getVariables({ type: 'chat' });
    if (history.program_history) {
      history.program_history = history.program_history.filter(p =>
        !(p.topic === item.topic && p.timestamp === item.timestamp)
      );
      replaceVariables(history, { type: 'chat' });
    }

    // é‡æ–°åŠ è½½
    historyPrograms = (history.program_history || []).sort(
      (a, b) => (b.timestamp || 0) - (a.timestamp || 0)
    );

    // é‡ç½®é¡µç åˆ°ç¬¬ä¸€é¡µ
    currentHistoryPage = 1;

    renderHistoryPrograms();
    toastr.warning('å·²åˆ é™¤');
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å†å²
   */
  function clearAllHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¿‡å¾€èŠ‚ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

    // æ¸…ç©ºæŒä¹…åŒ–å­˜å‚¨
    const history = getVariables({ type: 'chat' });
    history.program_history = [];
    replaceVariables(history, { type: 'chat' });

    historyPrograms = [];

    // é‡ç½®é¡µç åˆ°ç¬¬ä¸€é¡µ
    currentHistoryPage = 1;

    renderHistoryPrograms();
    toastr.success('å·²æ¸…ç©ºæ‰€æœ‰è¿‡å¾€èŠ‚ç›®');
  }

  /**
   * ä¿å­˜è®¾ç½®ï¼ˆç•Œé¢ç¼©æ”¾å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼‰
   */
  function saveSettingsFromUI() {
    const targetDoc = getTargetDocument();
    const scaleInput = targetDoc.getElementById('pp-scale-input');

    logger.debug('[saveSettingsFromUI] è·å–è¾“å…¥æ¡†å…ƒç´ :', { scaleInput });

    if (!scaleInput) {
      logger.error('[saveSettingsFromUI] è¾“å…¥æ¡†å…ƒç´ ä¸å­˜åœ¨');
      return;
    }

    settings.scale = parseFloat(scaleInput.value) || 1;

    logger.info('[saveSettingsFromUI] ä¿å­˜çš„è®¾ç½®:', JSON.stringify(settings));

    // ä¿å­˜åˆ°å…¨å±€å˜é‡
    const globalSettings = getVariables({ type: 'global' });
    logger.debug('[saveSettingsFromUI] è·å–å…¨å±€è®¾ç½®:', JSON.stringify(globalSettings));

    if (!globalSettings.pp_settings) {
      globalSettings.pp_settings = {};
    }
    globalSettings.pp_settings.scale = settings.scale;
    replaceVariables(globalSettings, { type: 'global' });
    logger.info('[saveSettingsFromUI] å·²ä¿å­˜åˆ°å…¨å±€å˜é‡');

    applySettings();
    toastr.success('è®¾ç½®å·²ä¿å­˜');
  }

  /**
   * åŠ è½½è®¾ç½®ï¼ˆä»å…¨å±€å˜é‡ï¼‰
   */
  function loadSettings() {
    logger.debug('[loadSettings] å¼€å§‹åŠ è½½è®¾ç½®');
    const globalSettings = getVariables({ type: 'global' });
    logger.debug('[loadSettings] è·å–åˆ°çš„å…¨å±€è®¾ç½®:', JSON.stringify(globalSettings));

    if (globalSettings.pp_settings) {
      settings.scale = globalSettings.pp_settings.scale || DEFAULT_SETTINGS.scale;
      logger.info('[loadSettings] ä»å…¨å±€å˜é‡åŠ è½½è®¾ç½®æˆåŠŸ:', JSON.stringify(settings));
    } else {
      logger.warn('[loadSettings] å…¨å±€å˜é‡ä¸­æ²¡æœ‰ pp_settingsï¼Œä½¿ç”¨é»˜è®¤å€¼:', JSON.stringify(settings));
    }
    applySettings();
  }

  // ========== ç»‘å®šå…¨å±€å‡½æ•° ==========
  window.ppTogglePanel = togglePanel;
  window.ppClosePanel = function () {
    const targetDoc = getTargetDocument();
    isPanelOpen = false;
    isSettingsMode = false;  // å…³é—­é¢æ¿æ—¶é‡ç½®è®¾ç½®æ¨¡å¼
    targetDoc.getElementById(PANEL_ID + '-container').style.display = 'none';
    targetDoc.getElementById(PANEL_ID).classList.remove('open');
  };
  window.ppSwitchTab = switchTab;
  window.ppExpandCard = expandCard;
  window.ppToggleJs = toggleJs;
  window.ppSendProgram = sendProgram;
  window.ppLoadFromHistory = loadFromHistory;
  window.ppDeleteHistory = deleteHistory;
  window.ppClearAllHistory = clearAllHistory;
  window.ppShowSettingsPage = showSettingsPage;
  window.ppShowMainPage = showMainPage;

  // ========== åˆå§‹åŒ– ==========
  /**
   * åˆå§‹åŒ–ç³»ç»Ÿ
   *
   * @description
   * æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
   * æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨å’Œæ¸…ç†æœºåˆ¶
   *
   * @returns {boolean} æ˜¯å¦æˆåŠŸåˆå§‹åŒ–ï¼ˆfalseè¡¨ç¤ºå·²åˆå§‹åŒ–è¿‡ï¼‰
   */
  function init() {
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (pp_initialized) {
      logger.warn('ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return false;
    }

    logger.info('å¼€å§‹åˆå§‹åŒ–èŠ‚ç›®å•...');
    pp_initialized = true;

    // æ³¨å†Œ pagehide äº‹ä»¶ï¼Œiframeå¸è½½æ—¶æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
    registerCleanupHandler();

    // æ³¨å…¥CSS
    injectStyles();

    // åŠ è½½è®¾ç½®
    logger.debug('[init] è°ƒç”¨ loadSettings');
    loadSettings();

    // ç»‘å®šå…¨å±€å‡½æ•°ï¼ˆç¡®ä¿åœ¨åˆ›å»ºé¢æ¿ä¹‹å‰ï¼‰
    bindGlobalFunctions();

    // åˆ›å»ºUI
    createToggleButton();
    createPanel();

    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
    eventOn('message_received', function () {
      if (isPanelOpen) {
        refreshData();
      }
    });

    logger.info('èŠ‚ç›®å•åˆå§‹åŒ–å®Œæˆ');
    return true;
  }

  /**
   * æ³¨å†Œæ¸…ç†å¤„ç†å™¨
   *
   * @description
   * ç›‘å¬ pagehide äº‹ä»¶ï¼Œåœ¨ iframe å¸è½½æ—¶è°ƒç”¨ cleanup
   * é˜²æ­¢äº‹ä»¶ç›‘å¬å™¨æ³„æ¼
   */
  function registerCleanupHandler() {
    logger.debug('æ³¨å†Œ pagehide æ¸…ç†å¤„ç†å™¨');

    // ä½¿ç”¨ jQuery ç›‘å¬ pagehide äº‹ä»¶ï¼ˆä¸é…’é¦†åŠ©æ‰‹ä¿æŒä¸€è‡´ï¼‰
    $(window).on('pagehide', () => {
      cleanup();
    });
  }

  /**
   * æ¸…ç†æ‰€æœ‰èµ„æº
   *
   * @description
   * é”€æ¯æ‚¬æµ®æŒ‰é’®å’Œé¢æ¿
   * æ¸…ç†é€šè¿‡ eventOn æ³¨å†Œçš„ç›‘å¬å™¨
   * åœ¨ iframe å¸è½½æ—¶è‡ªåŠ¨è°ƒç”¨
   */
  function cleanup() {
    logger.info('å¼€å§‹æ¸…ç†èŠ‚ç›®å•...');

    try {
      // é”€æ¯æ‚¬æµ®æŒ‰é’®
      const targetDoc = getTargetDocument();
      const btn = targetDoc.getElementById(BTN_ID);
      if (btn) {
        btn.remove();
        logger.debug('æ‚¬æµ®æŒ‰é’®å·²é”€æ¯');
      }

      // é”€æ¯é¢æ¿å®¹å™¨
      const container = targetDoc.getElementById(PANEL_ID + '-container');
      if (container) {
        container.remove();
        logger.debug('é¢æ¿å®¹å™¨å·²é”€æ¯');
      }

      // è°ƒç”¨é…’é¦†åŠ©æ‰‹çš„ eventClearAll å‡½æ•°
      if (typeof eventClearAll === 'function') {
        eventClearAll();
        logger.info('å·²è°ƒç”¨ eventClearAll æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨');
      } else {
        logger.warn('eventClearAll å‡½æ•°ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†');
      }

      // é‡ç½®åˆå§‹åŒ–æ ‡è®°ï¼Œå…è®¸ä¸‹æ¬¡é‡æ–°åˆå§‹åŒ–
      pp_initialized = false;

      logger.info('èŠ‚ç›®å•æ¸…ç†å®Œæˆ');
    } catch (error) {
      logger.error('æ¸…ç†è¿‡ç¨‹å‡ºé”™:', error);
    }
  }

  /**
   * ç»‘å®šå…¨å±€å‡½æ•°
   */
  function bindGlobalFunctions() {
    window.ppTogglePanel = togglePanel;
    window.ppClosePanel = function () {
      const targetDoc = getTargetDocument();
      isPanelOpen = false;
      isSettingsMode = false;  // å…³é—­é¢æ¿æ—¶é‡ç½®è®¾ç½®æ¨¡å¼
      targetDoc.getElementById(PANEL_ID + '-container').style.display = 'none';
      targetDoc.getElementById(PANEL_ID).classList.remove('open');
    };
    window.ppSwitchTab = switchTab;
    window.ppExpandCard = expandCard;
    window.ppToggleJs = toggleJs;
    window.ppSendProgram = sendProgram;
    window.ppLoadFromHistory = loadFromHistory;
    window.ppDeleteHistory = deleteHistory;
    window.ppClearAllHistory = clearAllHistory;
    window.ppShowSettingsPage = showSettingsPage;
    window.ppShowMainPage = showMainPage;
  }

  // å¯åŠ¨
  init();

})();

